var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf3=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _react=_interopRequireWildcard(require("react"));var _propTypes=require("prop-types");var _reactNative=require("react-native");var _findFirstMatch=_interopRequireDefault(require("./findFirstMatch"));var _getTransforms=_interopRequireDefault(require("./getTransforms"));var _getEasing=_interopRequireDefault(require("./getEasing"));var _getDuration=_interopRequireDefault(require("./getDuration"));var _getDimension=_interopRequireDefault(require("./getDimension"));var _transitionTypes=require("./transitionTypes");var _animationTypes=require("./animationTypes");var _styles=_interopRequireDefault(require("./styles"));var _jsxFileName="/Users/briandombrowski/Dev/Node/hookedjs/hookedjs/services/react/react-router-native-stack/lib/StackTransitioner.js";var ANIMATION_DURATION=500;var POSITION_THRESHOLD=1/2;var RESPOND_THRESHOLD=1;var GESTURE_RESPONSE_DISTANCE_HORIZONTAL=40;var StackTransitioner=function(_Component){(0,_inherits2.default)(StackTransitioner,_Component);function StackTransitioner(){var _getPrototypeOf2;var _this;(0,_classCallCheck2.default)(this,StackTransitioner);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=(0,_possibleConstructorReturn2.default)(this,(_getPrototypeOf2=(0,_getPrototypeOf3.default)(StackTransitioner)).call.apply(_getPrototypeOf2,[this].concat(args)));_this.state={previousLocation:{},transition:null,routeAnimationType:null,children:(0,_findFirstMatch.default)(_this.props.children,_this.props.location),previousChildren:null};_this.startingIndex=_this.props.history.index;_this.animation=null;_this.animatedValue=new _reactNative.Animated.Value(0);_this.isPanning=false;_this.isHorizontal=function(animationType){return animationType.indexOf('horizontal')>-1||animationType==='cube';};_this.panResponder=_reactNative.PanResponder.create({onMoveShouldSetPanResponder:function onMoveShouldSetPanResponder(event,gesture){return!_this.state.transition&&_this.isHorizontal(_this.state.routeAnimationType||_this.props.animationType)&&_this.props.gestureEnabled&&_this.props.history.index>_this.startingIndex&&_this.props.history.canGo(-1)&&event.nativeEvent.pageX<GESTURE_RESPONSE_DISTANCE_HORIZONTAL&&gesture.dx>RESPOND_THRESHOLD;},onPanResponderGrant:function onPanResponderGrant(event,_ref){var moveX=_ref.moveX;_this.isPanning=true;_this.props.history.goBack();},onPanResponderMove:function onPanResponderMove(event,_ref2){var moveX=_ref2.moveX;_this.animatedValue.setValue(moveX);},onPanResponderRelease:function onPanResponderRelease(event,_ref3){var dx=_ref3.dx,vx=_ref3.vx;var defaultVelocity=_this.getDimension()/ANIMATION_DURATION;var velocity=Math.max(Math.abs(vx),defaultVelocity);var resetDuration=dx/velocity;var goBackDuration=(_this.getDimension()-dx)/velocity;if(vx<-0.5){_this.cancelNavigation(resetDuration);return;}else if(vx>0.5){_this.finishNavigation(goBackDuration);return;}if(dx/_this.getDimension()<POSITION_THRESHOLD){_this.cancelNavigation(resetDuration);}else{_this.finishNavigation(goBackDuration);}}});_this.cancelNavigation=function(duration){_this.animation=_reactNative.Animated.timing(_this.animatedValue,{toValue:0,duration:duration,useNativeDriver:true}).start(function(_ref4){var finished=_ref4.finished;if(finished){_this.props.history.push(_this.state.previousLocation);_this.afterPan();}});};_this.finishNavigation=function(duration){_reactNative.Animated.timing(_this.animatedValue,{toValue:_this.getDimension(),duration:duration,useNativeDriver:true}).start(function(_ref5){var finished=_ref5.finished;if(finished){_this.afterPan();}});};_this.afterPan=function(){_this.props.isAnimating(false);_this.isPanning=false;_this.setState({previousLocation:{},transition:null});if(_this.props.history.action===_transitionTypes.POP){_this.setState({routeAnimationType:_this.state.children.props.animationType});}_this.animatedValue=new _reactNative.Animated.Value(0);_this.animation=null;};_this.getChildren=function(currentLocation,previousLocation){var children=_this.props.children;var currentChild=(0,_findFirstMatch.default)(children,currentLocation);if(!previousLocation){return[currentChild];}var previousChild=(0,_findFirstMatch.default)(children,previousLocation);return[currentChild,previousChild];};_this.getDimension=function(){return(0,_getDimension.default)(_this.state.routeAnimationType||_this.props.animationType,_this.props.width,_this.props.height);};_this.getRouteStyle=function(index){var _this$props=_this.props,animationType=_this$props.animationType,width=_this$props.width,height=_this$props.height,stackViewStyle=_this$props.stackViewStyle;var _this$state=_this.state,routeAnimationType=_this$state.routeAnimationType,transition=_this$state.transition;var _assertThisInitialize=(0,_assertThisInitialized2.default)(_this),animatedValue=_assertThisInitialize.animatedValue,isPanning=_assertThisInitialize.isPanning;var transitionType=isPanning?_transitionTypes.POP:transition;return[_styles.default.stackView,stackViewStyle,(0,_getTransforms.default)(width,height,animatedValue,routeAnimationType||animationType,transitionType,index)];};return _this;}(0,_createClass2.default)(StackTransitioner,[{key:"componentWillReceiveProps",value:function componentWillReceiveProps(nextProps){var _this2=this;var history=nextProps.history;var location=this.props.location;if(nextProps.location.key===location.key||!!this.state.transition){return;}var action=history.action;if(action===_transitionTypes.REPLACE&&this.props.replaceTransitionType){action=this.props.replaceTransitionType;}var _this$getChildren=this.getChildren(nextProps.location,location),_this$getChildren2=(0,_slicedToArray2.default)(_this$getChildren,2),children=_this$getChildren2[0],previousChildren=_this$getChildren2[1];var routeAnimationType=action===_transitionTypes.PUSH?children&&children.props.animationType:previousChildren&&previousChildren.props.animationType;this.setState({previousLocation:location,routeAnimationType:routeAnimationType,children:children,previousChildren:previousChildren});if(this.isPanning||routeAnimationType===_animationTypes.NONE||nextProps.animationType===_animationTypes.NONE&&!routeAnimationType||action===_transitionTypes.POP&&history.index<this.startingIndex||children&&previousChildren&&children.key===previousChildren.key){return;}if(action===_transitionTypes.PUSH||action===_transitionTypes.POP){this.setState({transition:action},function(){var dimension=_this2.getDimension();_this2.props.isAnimating(true);_this2.animation=_reactNative.Animated.timing(_this2.animatedValue,{duration:(0,_getDuration.default)(routeAnimationType||nextProps.animationType,action),toValue:action===_transitionTypes.PUSH?-dimension:dimension,easing:(0,_getEasing.default)(routeAnimationType||nextProps.animationType),useNativeDriver:true}).start(function(_ref6){var finished=_ref6.finished;if(finished){_this2.props.isAnimating(false);_this2.setState({previousLocation:{},transition:null});if(action===_transitionTypes.POP){_this2.setState({routeAnimationType:children.props.animationType});}_this2.animatedValue=new _reactNative.Animated.Value(0);_this2.animation=null;}});});}}},{key:"componentWillUnmount",value:function componentWillUnmount(){this.animation&&this.animation.stop();}},{key:"isFixed",value:function isFixed(element){var _this$state2=this.state,children=_this$state2.children,previousChildren=_this$state2.previousChildren;if(!children.props[element+"Component"])return false;if(!previousChildren)return true;return children.props[element+"Component"]===previousChildren.props[element+"Component"];}},{key:"render",value:function render(){var stackViewStyle=this.props.stackViewStyle;var _this$state3=this.state,children=_this$state3.children,previousChildren=_this$state3.previousChildren,transition=_this$state3.transition;var Header=children.props.headerComponent;var Footer=children.props.footerComponent;var PreviousHeader=previousChildren&&previousChildren.props.headerComponent;var PreviousFooter=previousChildren&&previousChildren.props.footerComponent;var routes=[];if(transition===_transitionTypes.PUSH){previousChildren&&routes.push(_react.default.createElement(_reactNative.Animated.View,{key:previousChildren.key,style:this.getRouteStyle(0),__source:{fileName:_jsxFileName,lineNumber:279}},!this.isFixed("footer")&&PreviousFooter&&_react.default.createElement(PreviousFooter,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:280}}),previousChildren,!this.isFixed("header")&&PreviousHeader&&_react.default.createElement(PreviousHeader,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:282}})));children&&routes.push(_react.default.createElement(_reactNative.Animated.View,{key:children.key,style:this.getRouteStyle(1),__source:{fileName:_jsxFileName,lineNumber:286}},!this.isFixed("footer")&&Footer&&_react.default.createElement(Footer,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:287}}),children,!this.isFixed("header")&&Header&&_react.default.createElement(Header,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:289}})));}else if(transition===_transitionTypes.POP||this.isPanning){children&&routes.push(_react.default.createElement(_reactNative.Animated.View,{key:children.key,style:this.getRouteStyle(0),__source:{fileName:_jsxFileName,lineNumber:294}},!this.isFixed("footer")&&Footer&&_react.default.createElement(Footer,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:295}}),children,!this.isFixed("header")&&Header&&_react.default.createElement(Header,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:297}})));previousChildren&&routes.push(_react.default.createElement(_reactNative.Animated.View,{key:previousChildren.key,style:this.getRouteStyle(1),__source:{fileName:_jsxFileName,lineNumber:301}},!this.isFixed("footer")&&PreviousFooter&&_react.default.createElement(PreviousFooter,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:302}}),previousChildren,!this.isFixed("header")&&PreviousHeader&&_react.default.createElement(PreviousHeader,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:304}})));}else{children&&routes.push(_react.default.createElement(_reactNative.Animated.View,{key:children.key,style:[_styles.default.stackView,stackViewStyle],__source:{fileName:_jsxFileName,lineNumber:309}},!this.isFixed("footer")&&Footer&&_react.default.createElement(Footer,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:310}}),children,!this.isFixed("header")&&Header&&_react.default.createElement(Header,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:312}})));}return _react.default.createElement(_reactNative.View,(0,_extends2.default)({key:"stack-view",style:[_styles.default.stackView,stackViewStyle]},this.panResponder.panHandlers,{__source:{fileName:_jsxFileName,lineNumber:318}}),this.isFixed("footer")&&_react.default.createElement(Footer,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:319}}),_react.default.createElement(_reactNative.View,{style:_styles.default.transitionContainer,__source:{fileName:_jsxFileName,lineNumber:320}},routes.map(function(route){return route;})),this.isFixed("header")&&_react.default.createElement(Header,{animatedValue:this.animatedValue,__source:{fileName:_jsxFileName,lineNumber:323}}));}}]);return StackTransitioner;}(_react.Component);exports.default=StackTransitioner;StackTransitioner.propTypes={children:_propTypes.node,history:_propTypes.object.isRequired,location:_propTypes.object.isRequired,width:_propTypes.number.isRequired,height:_propTypes.number.isRequired,animationType:_propTypes.string.isRequired,gestureEnabled:_propTypes.bool,stackViewStyle:_reactNative.ViewPropTypes.style,replaceTransitionType:(0,_propTypes.oneOf)([_transitionTypes.PUSH,_transitionTypes.POP]),isAnimating:_propTypes.func};